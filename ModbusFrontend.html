<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Modbus Frontend</title>
  <style>
    :root{
      --bg:#0f172a;--panel:#111827;--panel2:#1f2937;--line:#374151;--text:#e5e7eb;
      --muted:#9ca3af;--accent:#60a5fa;--ok:#34d399;--err:#f87171;--warn:#fbbf24;
    }
    *{box-sizing:border-box} body{margin:0;padding:20px;background:var(--bg);color:var(--text);font:14px/1.45 Inter,Segoe UI,Arial}
    h1{margin:0 0 14px;color:var(--accent);font-size:24px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .panel h2{margin:0 0 10px;font-size:16px;color:#bfdbfe}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    label{width:110px;color:var(--muted)} input,select,button,textarea{font:inherit}
    input,select,textarea{flex:1;min-width:140px;background:var(--panel2);color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px}
    button{background:#2563eb;border:0;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
    button:hover{filter:brightness(1.08)} button.secondary{background:#374151} button.danger{background:#dc2626} button.ok{background:#059669}
    .status{display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--panel2);border-radius:8px;margin-bottom:10px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;background:var(--err)} .dot.on{background:var(--ok)}
    .tabs{display:flex;gap:6px;margin-bottom:10px} .tab{padding:6px 10px;border-radius:8px;background:#374151;cursor:pointer} .tab.active{background:var(--accent);color:#111827;font-weight:700}
    .hidden{display:none!important}
    .log{background:#020617;border:1px solid #1e293b;border-radius:8px;padding:10px;min-height:120px;max-height:260px;overflow:auto;font-family:ui-monospace,Consolas,monospace;font-size:12px}
    .ok-t{color:var(--ok)} .err-t{color:var(--err)} .info-t{color:#93c5fd} .warn-t{color:var(--warn)}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--line);padding:6px;text-align:left;font-size:12px}
    th{color:#93c5fd}
    .full{grid-column:1/-1}
  </style>
</head>
<body>
  <h1>‚öô Modbus Control Panel</h1>

  <div class="grid">
    <section class="panel">
      <h2>üîå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h2>
      <div class="row"><label>API URL</label><input id="apiUrl" value="http://127.0.0.1:8080/" /></div>
      <div class="status"><span><span id="stDot" class="dot"></span><span id="stText">Disconnected</span></span><button id="btnStatus" class="secondary">Refresh</button></div>
      <div class="tabs"><div class="tab active" data-t="tcp">TCP</div><div class="tab" data-t="rtu">RTU</div></div>

      <div id="tcpBox">
        <div class="row"><label>Host</label><input id="tcpHost" value="127.0.0.1"/></div>
        <div class="row"><label>Port</label><input id="tcpPort" type="number" value="502"/></div>
      </div>
      <div id="rtuBox" class="hidden">
        <div class="row"><label>Port</label><input id="rtuPort" value="/dev/ttyUSB0"/></div>
        <div class="row"><label>Baud</label><select id="rtuBaud"><option>9600</option><option>19200</option><option selected>38400</option><option>57600</option><option>115200</option></select></div>
        <div class="row"><label>Stop bits</label><select id="rtuStop"><option selected>1</option><option>2</option></select></div>
        <div class="row"><label>Ports</label><select id="serialList"></select><button id="btnPorts" class="secondary">Scan</button></div>
      </div>

      <div class="row"><button id="btnOpen" class="ok">Open</button><button id="btnSwitch">Switch</button><button id="btnClose" class="danger">Close</button></div>
      <div id="logTransport" class="log"></div>
    </section>

    <section class="panel">
      <h2>üìñ –ß—Ç–µ–Ω–∏–µ</h2>
      <div class="row"><label>Slave ID</label><input id="rSlave" type="number" value="1"/></div>
      <div class="row"><label>Address</label><input id="rAddr" value="0x0000"/></div>
      <div class="row"><label>Count</label><input id="rCount" type="number" value="10"/></div>
      <div class="row"><label>Input regs</label><input id="rInput" type="checkbox" style="flex:0"/></div>
      <div class="row"><button id="btnRead">Read</button><button id="btnReadAdd" class="secondary">Add batch</button><button id="btnReadBatch">Run batch</button></div>
      <table><thead><tr><th>Slave</th><th>Addr</th><th>Count</th><th>Input</th><th></th></tr></thead><tbody id="readBatch"></tbody></table>
      <div id="logRead" class="log"></div>
    </section>

    <section class="panel">
      <h2>‚úç –ó–∞–ø–∏—Å—å</h2>
      <div class="row"><label>Slave ID</label><input id="wSlave" type="number" value="1"/></div>
      <div class="row"><label>Address</label><input id="wAddr" value="0x0000"/></div>
      <div class="row"><label>Values</label><input id="wVals" placeholder="123 or 1,2,3"/></div>
      <div class="row"><button id="btnWrite" class="ok">Write</button><button id="btnWriteAdd" class="secondary">Add batch</button><button id="btnWriteBatch">Run batch</button></div>
      <table><thead><tr><th>Slave</th><th>Addr</th><th>Values</th><th></th></tr></thead><tbody id="writeBatch"></tbody></table>
      <div id="logWrite" class="log"></div>
    </section>

    <section class="panel full">
      <h2>üìã –û–±—â–∏–π –ª–æ–≥</h2>
      <div class="row"><button id="btnPing">Ping</button><button id="btnClear" class="secondary">Clear</button></div>
      <div id="logMain" class="log" style="max-height:420px"></div>
    </section>
  </div>

<script>
const $ = id => document.getElementById(id);
const state = { transport: 'tcp', readBatch: [], writeBatch: [] };

function l(logId, msg, cls='info-t') {
  const t = new Date().toLocaleTimeString();
  const el = $(logId);
  el.innerHTML += `<div class="${cls}">[${t}] ${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}

function parseAddress(v){
  const s = String(v).trim();
  if (/^0x[0-9a-f]+$/i.test(s)) return s;
  const n = Number(s);
  if (Number.isFinite(n) && n >= 0) return Math.trunc(n);
  throw new Error('Invalid address format');
}

function apiUrl(){ return $('apiUrl').value.trim(); }

async function sendRpc(method, params = {}) {
  const payload = { jsonrpc:'2.0', id: Date.now()+Math.random(), method, params };
  l('logMain', `‚Üí ${method} ${JSON.stringify(params)}`,'info-t');
  try {
    const res = await fetch(apiUrl(), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const json = await res.json();
    if (json.error) {
      l('logMain', `‚úó ${json.error.code}: ${json.error.message}`,'err-t');
      return { error: json.error };
    }
    l('logMain', `‚úì ${method}`,'ok-t');
    return { result: json.result };
  } catch (e) {
    l('logMain', `‚úó NET ${e.message}`,'err-t');
    return { error: { message: e.message } };
  }
}

function setStatus(s){
  const active = !!s?.active;
  $('stDot').classList.toggle('on', active);
  $('stText').textContent = active
    ? `${(s.type || '?').toUpperCase()} ${s.type === 'tcp' ? `${s.host}:${s.port}` : `${s.serial_port}@${s.baud_rate}`}`
    : 'Disconnected';
}

async function refreshStatus(){
  const {result} = await sendRpc('transport.status');
  if (result) setStatus(result);
}

async function loadSerialPorts(){
  const {result,error} = await sendRpc('transport.serial_ports');
  if (error) return;
  const select = $('serialList');
  select.innerHTML = '';
  const ports = result?.ports || [];
  if (!ports.length) {
    select.innerHTML = '<option value="">(no ports)</option>';
    return;
  }
  for (const p of ports) {
    const o = document.createElement('option'); o.value = p; o.textContent = p;
    select.appendChild(o);
  }
  $('rtuPort').value = ports[0];
}

function transportParams(){
  if (state.transport === 'tcp') {
    return { type:'tcp', host:$('tcpHost').value.trim(), port:Number($('tcpPort').value) };
  }
  return {
    type:'rtu',
    serial_port:$('rtuPort').value.trim(),
    baud_rate:Number($('rtuBaud').value),
    stop_bits:Number($('rtuStop').value)
  };
}

async function doOpen(method){
  const {result,error} = await sendRpc(method, transportParams());
  if (error) return l('logTransport', `‚úó ${error.message}`,'err-t');
  l('logTransport', `‚úì ${method}: ${JSON.stringify(result)}`,'ok-t');
  await refreshStatus();
}

function addReadBatchRow(item){
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${item.slave_id}</td><td>${item.address}</td><td>${item.count}</td><td>${item.input?'‚úì':''}</td><td><button class="danger">x</button></td>`;
  tr.querySelector('button').onclick = () => {
    const idx = [...$('readBatch').children].indexOf(tr);
    if (idx >= 0) state.readBatch.splice(idx,1);
    tr.remove();
  };
  $('readBatch').appendChild(tr);
}

function addWriteBatchRow(item){
  const tr = document.createElement('tr');
  const vals = item.values ? item.values.join(',') : item.value;
  tr.innerHTML = `<td>${item.slave_id}</td><td>${item.address}</td><td>${vals}</td><td><button class="danger">x</button></td>`;
  tr.querySelector('button').onclick = () => {
    const idx = [...$('writeBatch').children].indexOf(tr);
    if (idx >= 0) state.writeBatch.splice(idx,1);
    tr.remove();
  };
  $('writeBatch').appendChild(tr);
}

async function readSingle(){
  try {
    const params = {
      slave_id:Number($('rSlave').value),
      address:parseAddress($('rAddr').value),
      count:Number($('rCount').value),
      input:$('rInput').checked
    };
    const {result,error} = await sendRpc('modbus.read', params);
    if (error) return l('logRead', `‚úó ${error.message}`,'err-t');

    // –ö—Ä–∏—Ç–∏—á–Ω—ã–π —Ñ–∏–∫—Å: backend –æ—Ç–¥–∞–µ—Ç values –≤ result.values (–¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç),
    // –Ω–æ –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–º–æ–∂–Ω–∞ –æ–±–µ—Ä—Ç–∫–∞ result.result.values ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞.
    const values = result?.values ?? result?.result?.values ?? [];
    const meta = {
      slave_id: result?.slave_id ?? params.slave_id,
      address: result?.address ?? params.address,
      count: result?.count ?? params.count,
      function: result?.function ?? (params.input ? 'read_input' : 'read_holding')
    };

    l('logRead', `‚úì Read ${JSON.stringify(meta)} values=${JSON.stringify(values)}`,'ok-t');
  } catch (e) {
    l('logRead', `‚úó ${e.message}`,'err-t');
  }
}

async function readBatch(){
  if (!state.readBatch.length) return l('logRead', '‚ö† batch empty','warn-t');
  const {result,error} = await sendRpc('modbus.read_group', { requests: state.readBatch });
  if (error) return l('logRead', `‚úó ${error.message}`,'err-t');
  const rows = result?.results || [];
  l('logRead', `‚úì Group read: ${rows.length} results`,'ok-t');
  rows.forEach((r,i)=> l('logRead', `  [${i}] slave=${r.slave_id} addr=${r.address} count=${r.count} values=${JSON.stringify(r.values||[])}`,'info-t'));
}

async function writeSingle(){
  try {
    const vals = $('wVals').value.split(',').map(v=>v.trim()).filter(Boolean).map(Number).filter(v=>!Number.isNaN(v));
    if (!vals.length) return l('logWrite','‚ö† values required','warn-t');
    const params = { slave_id:Number($('wSlave').value), address:parseAddress($('wAddr').value) };
    if (vals.length === 1) params.value = vals[0]; else params.values = vals;
    const {result,error} = await sendRpc('modbus.write', params);
    if (error) return l('logWrite', `‚úó ${error.message}`,'err-t');
    l('logWrite', `‚úì Write ${JSON.stringify(result)}`,'ok-t');
  } catch (e) {
    l('logWrite', `‚úó ${e.message}`,'err-t');
  }
}

async function writeBatch(){
  if (!state.writeBatch.length) return l('logWrite', '‚ö† batch empty','warn-t');
  const {result,error} = await sendRpc('modbus.write_group', { requests: state.writeBatch });
  if (error) return l('logWrite', `‚úó ${error.message}`,'err-t');
  l('logWrite', `‚úì Group write: ${JSON.stringify(result)}`,'ok-t');
}

function wire(){
  document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    state.transport = t.dataset.t;
    $('tcpBox').classList.toggle('hidden', state.transport!=='tcp');
    $('rtuBox').classList.toggle('hidden', state.transport!=='rtu');
  });

  $('btnStatus').onclick = refreshStatus;
  $('btnPorts').onclick = loadSerialPorts;
  $('serialList').onchange = e => $('rtuPort').value = e.target.value;

  $('btnOpen').onclick = () => doOpen('transport.open');
  $('btnSwitch').onclick = () => doOpen('transport.switch');
  $('btnClose').onclick = async ()=>{ const r = await sendRpc('transport.close'); if(!r.error){ l('logTransport','‚úì Closed','ok-t'); await refreshStatus(); } };

  $('btnRead').onclick = readSingle;
  $('btnReadAdd').onclick = ()=>{
    try {
      const item = { slave_id:Number($('rSlave').value), address:parseAddress($('rAddr').value), count:Number($('rCount').value), input:$('rInput').checked };
      state.readBatch.push(item); addReadBatchRow(item);
    } catch (e) { l('logRead',`‚úó ${e.message}`,'err-t'); }
  };
  $('btnReadBatch').onclick = readBatch;

  $('btnWrite').onclick = writeSingle;
  $('btnWriteAdd').onclick = ()=>{
    try {
      const values = $('wVals').value.split(',').map(v=>v.trim()).filter(Boolean).map(Number).filter(v=>!Number.isNaN(v));
      if (!values.length) return l('logWrite','‚ö† values required','warn-t');
      const item = { slave_id:Number($('wSlave').value), address:parseAddress($('wAddr').value) };
      if (values.length===1) item.value = values[0]; else item.values = values;
      state.writeBatch.push(item); addWriteBatchRow(item);
    } catch (e) { l('logWrite',`‚úó ${e.message}`,'err-t'); }
  };
  $('btnWriteBatch').onclick = writeBatch;

  $('btnPing').onclick = async ()=>{ const r = await sendRpc('ping'); if(!r.error) l('logMain',`pong ${JSON.stringify(r.result)}`,'ok-t'); };
  $('btnClear').onclick = ()=> $('logMain').innerHTML = '';
}

wire();
refreshStatus();
setInterval(refreshStatus, 30000);
</script>
</body>
</html>
