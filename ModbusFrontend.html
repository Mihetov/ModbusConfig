<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modbus Control Panel</title>
  <style>
    :root {
      --bg: #1e1e2e; --panel: #2a2a3e; --accent: #89b4fa;
      --success: #a6e3a1; --error: #f38ba8; --text: #cdd6f4;
      --border: #45475a; --input: #313244;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg); color: var(--text);
      padding: 20px; line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    
    .panel {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 8px; padding: 16px;
    }
    .panel h3 {
      color: var(--accent); margin-bottom: 12px; padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .form-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .form-row label { min-width: 100px; font-size: 0.9em; display: flex; align-items: center; }
    .form-row input, .form-row select {
      flex: 1; min-width: 120px; padding: 6px 10px;
      background: var(--input); border: 1px solid var(--border);
      border-radius: 4px; color: var(--text);
    }
    .form-row input[type="number"] { width: 80px; }
    
    .btn {
      padding: 8px 16px; background: var(--accent); color: #111;
      border: none; border-radius: 4px; cursor: pointer;
      font-weight: 600; transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-danger { background: var(--error); color: #111; }
    .btn-success { background: var(--success); color: #111; }
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    
    .status-bar {
      padding: 8px 12px; background: var(--input);
      border-radius: 4px; margin: 10px 0; font-size: 0.9em;
      display: flex; justify-content: space-between; align-items: center;
    }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--error); display: inline-block; margin-right: 6px;
    }
    .status-dot.active { background: var(--success); }
    
    .log {
      background: #111; border-radius: 4px; padding: 10px;
      max-height: 300px; overflow-y: auto; font-family: monospace;
      font-size: 0.85em; white-space: pre-wrap;
    }
    .log .error { color: var(--error); }
    .log .success { color: var(--success); }
    .log .info { color: #89dceb; }
    
    .hidden { display: none !important; }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--accent); }
    
    .tabs { display: flex; gap: 4px; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
    .tab { padding: 6px 12px; cursor: pointer; border-radius: 4px 4px 0 0; }
    .tab.active { background: var(--accent); color: #111; font-weight: 600; }
    
    @media (max-width: 768px) {
      .container { grid-template-columns: 1fr; }
    }
    /* –¶–≤–µ—Ç–∞ –¥–ª—è access-—Ñ–ª–∞–≥–æ–≤ */
.success { color: var(--success); font-weight: 600; }
.error { color: var(--error); font-weight: 600; }
.info { color: #89dceb; font-weight: 600; }

/* –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ */
#registersTable code {
  background: var(--input); padding: 2px 6px; border-radius: 3px;
  font-family: monospace; font-size: 0.9em;
}
#registersTable td { vertical-align: middle; }
#registersTable button { margin: 2px 0; }

/* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
@media (max-width: 1200px) {
  #registersTable { font-size: 0.85em; }
  #registersTable th:nth-child(6),
  #registersTable td:nth-child(6),
  #registersTable th:nth-child(7),
  #registersTable td:nth-child(7) { display: none; }
}
#registersTable td.success {
  background: rgba(166, 227, 161, 0.2);
  transition: background 0.5s;
}

/* –û—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è */
#registersTable td .error {
  color: var(--error);
  font-weight: 600;
}

/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
#progressBar {
  background: linear-gradient(90deg, var(--accent), #b4befe);
  box-shadow: 0 0 10px rgba(137, 180, 250, 0.5);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
#readProgress:not(.hidden) #progressText {
  animation: pulse 1.5s infinite;
}
  </style>
</head>
<body>

<h2 style="text-align:center; color:var(--accent); margin-bottom:20px;">‚öôÔ∏è Modbus Control Panel</h2>

<div class="container">

  <!-- üîå Transport Panel -->
  <div class="panel">
    <h3>üîå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h3>
    
    <div class="status-bar">
      <span><span class="status-dot" id="statusDot"></span><span id="statusText">Disconnected</span></span>
      <button class="btn" id="refreshStatusBtn">üîÑ Refresh</button>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-type="tcp">TCP</div>
      <div class="tab" data-type="rtu">RTU</div>
    </div>
    
    <!-- TCP Settings -->
    <div id="tcpSettings">
      <div class="form-row">
        <label>Host:</label>
        <input type="text" id="tcpHost" value="127.0.0.1"/>
      </div>
      <div class="form-row">
        <label>Port:</label>
        <input type="number" id="tcpPort" value="502" min="1" max="65535"/>
      </div>
    </div>
    
    <!-- RTU Settings -->
    <div id="rtuSettings" class="hidden">
      <div class="form-row">
        <label>Port:</label>
        <input type="text" id="rtuPort" value="/dev/ttyUSB0"/>
      </div>
      <div class="form-row">
        <label>Baud:</label>
        <select id="rtuBaud">
          <option value="9600">9600</option>
          <option value="19200">19200</option>
          <option value="38400" selected>38400</option>
          <option value="57600">57600</option>
          <option value="115200">115200</option>
        </select>
      </div>
      <div class="form-row">
        <label>Stop Bits:</label>
        <select id="rtuStopBits">
          <option value="1" selected>1</option>
          <option value="2">2</option>
        </select>
      </div>
    </div>
    
    <div class="btn-group">
      <button class="btn btn-success" id="openBtn">üîó Open</button>
      <button class="btn btn-danger" id="closeBtn">‚úñ Close</button>
      <button class="btn" id="switchBtn">üîÅ Switch</button>
    </div>
    
    <div class="log" id="transportLog"></div>
  </div>

  <!-- üìñ Modbus Read Panel -->
  <div class="panel">
    <h3>üìñ –ß—Ç–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤</h3>
    
    <div class="form-row">
      <label>Slave ID:</label>
      <input type="number" id="readSlave" value="1" min="1" max="247"/>
    </div>
    <div class="form-row">
      <label>Address:</label>
      <input type="number" id="readAddress" value="0" min="0"/>
    </div>
    <div class="form-row">
      <label>Count:</label>
      <input type="number" id="readCount" value="10" min="1" max="125"/>
    </div>
    <div class="form-row">
      <label><input type="checkbox" id="readInput"/> Input Registers</label>
    </div>
    
    <div class="btn-group">
      <button class="btn" id="readSingleBtn">üì• Read</button>
      <button class="btn" id="readBatchBtn">üì¶ Batch Read</button>
    </div>
    
    <div style="margin-top:12px;">
      <small style="color:#9399b2;">–î–æ–±–∞–≤–∏—Ç—å –≤ batch:</small>
      <table id="batchReadTable">
        <thead><tr><th>Slave</th><th>Addr</th><th>Count</th><th>In</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn" id="addBatchReadBtn" style="margin-top:8px;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    
    <div class="log" id="readLog"></div>
  </div>

  <!-- ‚úçÔ∏è Modbus Write Panel -->
  <div class="panel">
    <h3>‚úçÔ∏è –ó–∞–ø–∏—Å—å —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤</h3>
    
    <div class="form-row">
      <label>Slave ID:</label>
      <input type="number" id="writeSlave" value="1" min="1" max="247"/>
    </div>
    <div class="form-row">
      <label>Address:</label>
      <input type="number" id="writeAddress" value="0" min="0"/>
    </div>
    <div class="form-row">
      <label>Value(s):</label>
      <input type="text" id="writeValues" placeholder="1234 –∏–ª–∏ 100,200,300"/>
    </div>
    
    <div class="btn-group">
      <button class="btn btn-success" id="writeBtn">‚úçÔ∏è Write</button>
      <button class="btn" id="writeBatchBtn">üì¶ Batch Write</button>
    </div>
    
    <div style="margin-top:12px;">
      <small style="color:#9399b2;">Batch –∑–∞–ø–∏—Å–∏:</small>
      <table id="batchWriteTable">
        <thead><tr><th>Slave</th><th>Addr</th><th>Values</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn" id="addBatchWriteBtn" style="margin-top:8px;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    
    <div class="log" id="writeLog"></div>
  </div>

  <!-- üìã Response Log -->
  <div class="panel" style="grid-column: 1 / -1;">
    <h3>üìã –õ–æ–≥–∏ –æ—Ç–≤–µ—Ç–æ–≤</h3>
    <div class="log" id="responseLog" style="max-height:400px;"></div>
    <div class="btn-group" style="margin-top:10px;">
      <button class="btn" id="clearLogBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
      <button class="btn" id="pingBtn">üèì Ping</button>
    </div>
  </div>
  <!-- üóÇÔ∏è Register Import Panel -->
<div class="panel" style="grid-column: 1 / -1;">
  <h3>üóÇÔ∏è –†–µ–≥–∏—Å—Ç—Ä—ã (CSV –∏–º–ø–æ—Ä—Ç)</h3>
  
  <div class="form-row">
  <label>–§–∞–π–ª:</label>
  <input type="file" id="csvFile" accept=".csv,.txt"/>
  <button class="btn" id="importBtn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button class="btn btn-danger" id="clearRegistersBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
  <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê -->
  <button class="btn btn-success" id="readAllBtn" disabled>üì° –ß–∏—Ç–∞—Ç—å –≤—Å–µ</button>
  <button class="btn" id="showStatsBtn">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
</div>

<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π) -->
<div id="readProgress" class="hidden" style="margin-top:10px;">
  <div style="display:flex; justify-content:space-between; margin-bottom:4px; font-size:0.9em;">
    <span id="progressText">–ß—Ç–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤...</span>
    <span id="progressPercent">0%</span>
  </div>
  <div style="background:var(--input); border-radius:4px; height:8px; overflow:hidden;">
    <div id="progressBar" style="background:var(--accent); height:100%; width:0%; transition:width 0.2s;"></div>
  </div>
</div>
  
  <div class="form-row">
    <label>–§–∏–ª—å—Ç—Ä:</label>
    <input type="text" id="registerFilter" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..."/>
    <label>–¢–æ–ª—å–∫–æ RWE:</label>
    <input type="checkbox" id="filterRwe"/>
    <label>Slave ID:</label>
    <input type="number" id="filterSlave" value="1" min="1" max="247" style="width:70px"/>
  </div>
  
  <div style="overflow-x:auto; margin-top:10px;">
    <table id="registersTable">
      <thead>
        <tr>
          <th>Addr</th>
          <th>Mnemonic</th>
          <th>Access</th>
          <th>Count</th>
          <th>Type</th>
          <th>Min</th>
          <th>Max</th>
          <th>Description</th>
          <th>Value</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="registersBody">
        <tr><td colspan="10" style="text-align:center; color:#9399b2;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤</td></tr>
      </tbody>
    </table>
  </div>
  
  <div class="log" id="importLog" style="max-height:150px;"></div>
</div>
</div>

<script>
// ==================== CONFIG ====================
const API_URL = 'http://127.0.0.1:8001/'; // ‚Üê –∏–∑–º–µ–Ω–∏—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

// ==================== UTILS ====================
const $ = id => document.getElementById(id);
const log = (elId, msg, type='info') => {
  const el = $(elId);
  const time = new Date().toLocaleTimeString();
  el.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
  el.scrollTop = el.scrollHeight;
};
const clearLog = elId => $(elId).innerHTML = '';

const sendRpc = async (method, params = {}) => {
  const payload = { jsonrpc: '2.0', method, params, id: Date.now() };
  log('responseLog', `‚Üí ${method}`, 'info');
  
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const json = await res.json();
    
    if (json.error) {
      log('responseLog', `‚úó ${json.error.code}: ${json.error.message}`, 'error');
      return { error: json.error };
    }
    
    log('responseLog', `‚úì ${method}: ${JSON.stringify(json.result)}`, 'success');
    return { result: json.result };
  } catch (e) {
    log('responseLog', `‚úó Network error: ${e.message}`, 'error');
    return { error: { code: -1, message: e.message } };
  }
};

// ==================== TRANSPORT ====================
let currentType = 'tcp';

const updateTransportUI = (status) => {
  const dot = $('statusDot');
  const text = $('statusText');
  
  if (status?.active) {
    dot.classList.add('active');
    text.textContent = `${status.type?.toUpperCase()} @ ${status.host || status.serial_port}:${status.port || status.baud_rate}`;
  } else {
    dot.classList.remove('active');
    text.textContent = 'Disconnected';
  }
};

const refreshStatus = async () => {
  const { result } = await sendRpc('transport.status');
  if (result) updateTransportUI(result);
};

$('refreshStatusBtn').onclick = refreshStatus;

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentType = tab.dataset.type;
    $('tcpSettings').classList.toggle('hidden', currentType !== 'tcp');
    $('rtuSettings').classList.toggle('hidden', currentType !== 'rtu');
  };
});

// Open
$('openBtn').onclick = async () => {
  const params = { type: currentType };
  if (currentType === 'tcp') {
    params.host = $('tcpHost').value;
    params.port = parseInt($('tcpPort').value);
  } else {
    params.serial_port = $('rtuPort').value;
    params.baud_rate = parseInt($('rtuBaud').value);
    params.stop_bits = parseInt($('rtuStopBits').value);
  }
  const { result } = await sendRpc('transport.open', params);
  if (result) {
    log('transportLog', `‚úì Opened ${currentType}`, 'success');
    refreshStatus();
  }
};

// Close
$('closeBtn').onclick = async () => {
  const { result } = await sendRpc('transport.close');
  if (result) {
    log('transportLog', '‚úì Closed', 'success');
    updateTransportUI({ active: false });
  }
};

// Switch
$('switchBtn').onclick = async () => {
  const params = { type: currentType };
  if (currentType === 'tcp') {
    params.host = $('tcpHost').value;
    params.port = parseInt($('tcpPort').value);
  } else {
    params.serial_port = $('rtuPort').value;
    params.baud_rate = parseInt($('rtuBaud').value);
    params.stop_bits = parseInt($('rtuStopBits').value);
  }
  const { result } = await sendRpc('transport.switch', params);
  if (result) {
    log('transportLog', `‚úì Switched to ${currentType}`, 'success');
    refreshStatus();
  }
};

// ==================== READ ====================
const doRead = async () => {
  const params = {
    slave_id: parseInt($('readSlave').value),
    address: parseInt($('readAddress').value),
    count: parseInt($('readCount').value),
    input: $('readInput').checked
  };
  const { result, error } = await sendRpc('modbus.read', params);
  if (result) log('readLog', `‚úì Accepted: ${JSON.stringify(result)}`, 'success');
  if (error) log('readLog', `‚úó ${error.message}`, 'error');
};

$('readSingleBtn').onclick = doRead;

// Batch read
const batchReadItems = [];

$('addBatchReadBtn').onclick = () => {
  const item = {
    slave_id: parseInt($('readSlave').value),
    address: parseInt($('readAddress').value),
    count: parseInt($('readCount').value),
    input: $('readInput').checked
  };
  batchReadItems.push(item);
  
  const tbody = $('batchReadTable').querySelector('tbody');
  const row = tbody.insertRow();
  row.innerHTML = `
    <td>${item.slave_id}</td>
    <td>${item.address}</td>
    <td>${item.count}</td>
    <td>${item.input ? '‚úì' : ''}</td>
    <td><button class="btn btn-danger" style="padding:2px 8px;">‚úñ</button></td>
  `;
  row.querySelector('button').onclick = () => {
    const idx = Array.from(tbody.rows).indexOf(row);
    batchReadItems.splice(idx, 1);
    row.remove();
  };
};

$('readBatchBtn').onclick = async () => {
  if (batchReadItems.length === 0) {
    log('readLog', '‚ö† –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –≤ batch', 'error');
    return;
  }
  const { result, error } = await sendRpc('modbus.read_group', { requests: batchReadItems });
  if (result) log('readLog', `‚úì Batch accepted: ${result.count} requests`, 'success');
  if (error) log('readLog', `‚úó ${error.message}`, 'error');
};

// ==================== WRITE ====================
const doWrite = async () => {
  const slave_id = parseInt($('writeSlave').value);
  const address = parseInt($('writeAddress').value);
  const valStr = $('writeValues').value.trim();
  
  const values = valStr.split(',').map(v => parseInt(v.trim())).filter(v => !isNaN(v));
  if (values.length === 0) {
    log('writeLog', '‚ö† –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è', 'error');
    return;
  }
  
  const params = { slave_id, address };
  if (values.length === 1) {
    params.value = values[0];
  } else {
    params.values = values;
  }
  
  const { result, error } = await sendRpc('modbus.write', params);
  if (result) log('writeLog', '‚úì Write accepted', 'success');
  if (error) log('writeLog', `‚úó ${error.message}`, 'error');
};

$('writeBtn').onclick = doWrite;

// Batch write
const batchWriteItems = [];

$('addBatchWriteBtn').onclick = () => {
  const slave_id = parseInt($('writeSlave').value);
  const address = parseInt($('writeAddress').value);
  const valStr = $('writeValues').value.trim();
  const values = valStr.split(',').map(v => parseInt(v.trim())).filter(v => !isNaN(v));
  
  if (values.length === 0) return;
  
  const item = { slave_id, address };
  if (values.length === 1) {
    item.value = values[0];
  } else {
    item.values = values;
  }
  batchWriteItems.push(item);
  
  const tbody = $('batchWriteTable').querySelector('tbody');
  const row = tbody.insertRow();
  row.innerHTML = `
    <td>${item.slave_id}</td>
    <td>${item.address}</td>
    <td>${values.join(',')}</td>
    <td><button class="btn btn-danger" style="padding:2px 8px;">‚úñ</button></td>
  `;
  row.querySelector('button').onclick = () => {
    const idx = Array.from(tbody.rows).indexOf(row);
    batchWriteItems.splice(idx, 1);
    row.remove();
  };
};

$('writeBatchBtn').onclick = async () => {
  if (batchWriteItems.length === 0) {
    log('writeLog', '‚ö† –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –≤ batch', 'error');
    return;
  }
  const { result, error } = await sendRpc('modbus.write_group', { requests: batchWriteItems });
  if (result) log('writeLog', `‚úì Batch accepted: ${result.count} requests`, 'success');
  if (error) log('writeLog', `‚úó ${error.message}`, 'error');
};

// ==================== GLOBAL ====================
$('pingBtn').onclick = () => sendRpc('ping');
$('clearLogBtn').onclick = () => clearLog('responseLog');

// Init
$('responseLog').innerHTML = `<div class="info">[System] Ready. Connect to ${API_URL}</div>`;
refreshStatus();

// Auto-refresh status every 30s
setInterval(refreshStatus, 30000);
// ==================== REGISTERS ====================
let registers = []; // {addr, mnemonic, access, count, type, min, max, description, value}

// –ü–∞—Ä—Å–∏–Ω–≥ CSV –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// –ü–∞—Ä—Å–∏–Ω–≥ CSV –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
// HREG=48;Register=100;Red.=24;RWE=32;Bytes=28;Type=40;Min=32;Max=32;Description=200;S=16;Value=400
// 0xF000;HREG_slaveID;A.;RWE;2;Word;1;247;–°–µ—Ç–µ–≤–æ–π –∞–¥—Ä–µ—Å;;247

const parseRegisterCsv = (text) => {
  const lines = text.trim().split('\n');
  const result = [];
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
    if (!line || line.startsWith(';;;;;;;;;;')) continue;
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É-–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ö–µ–º—ã (—Å–æ–¥–µ—Ä–∂–∏—Ç "HREG=")
    if (line.startsWith('HREG=')) continue;
    
    const parts = line.split(';').map(p => p.trim());
    
    // –û–∂–∏–¥–∞–µ–º 11 –ø–æ–ª–µ–π: Addr;Mnemonic;Flag;Access;Count;Type;Min;Max;Description;Extra;Value
    if (parts.length < 9) continue;
    
    // –ü–∞—Ä—Å–∏–º –∞–¥—Ä–µ—Å (–º–æ–∂–µ—Ç –±—ã—Ç—å 0xF000 –∏–ª–∏ –¥–µ—Å—è—Ç–∏—á–Ω—ã–π)
    let addrStr = parts[0];
    const addrNum = addrStr.startsWith('0x') || addrStr.startsWith('0X') 
      ? parseInt(addrStr, 16) 
      : parseInt(addrStr);
    
    if (isNaN(addrNum)) {
      console.warn(`[CSV] –ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ ${i+1}: –Ω–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å "${addrStr}"`);
      continue;
    }
    
    // –ü–∞—Ä—Å–∏–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    const parseNum = (val, def = null) => {
      if (val === '' || val === undefined) return def;
      const num = val.includes('.') ? parseFloat(val) : parseInt(val);
      return isNaN(num) ? def : num;
    };
    
    const reg = {
      addr: addrNum,
      addrHex: '0x' + addrNum.toString(16).toUpperCase().padStart(4, '0'),
      mnemonic: parts[1] || '',
      flag: parts[2] || '',           // A., F., b., P., t., U., d. –∏ —Ç.–¥.
      access: parts[3] || '',         // R, W, RW, RWE
      count: parseNum(parts[4], 1),   // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
      type: parts[5] || 'Word',       // Word, Byte, Int8, Int16, Int32, Float, String, TCP56, Array
      min: parseNum(parts[6]),
      max: parseNum(parts[7]),
      description: parts[8] || '',
      extra: parts[9] || '',          // –¥–æ–ø. –ø–æ–ª–µ (—á–∞—Å—Ç–æ –ø—É—Å—Ç–æ–µ)
      value: parseNum(parts[10]),     // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é / —Ç–µ–∫—É—â–µ–µ
      writable: (parts[3] || '').includes('W')
    };
    
    result.push(reg);
  }
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–¥—Ä–µ—Å—É
  return result.sort((a, b) => a.addr - b.addr);
};

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
const renderRegisters = (filterText = '') => {
  const tbody = $('registersBody');
  const filter = filterText.toLowerCase();
  const onlyRwe = $('filterRwe').checked;
  const slaveId = parseInt($('filterSlave').value) || 1;
  
  const filtered = registers.filter(r => {
    if (onlyRwe && !r.access.includes('W')) return false;
    if (filter && !r.addrHex.toLowerCase().includes(filter) && 
                  !r.mnemonic.toLowerCase().includes(filter) &&
                  !r.description.toLowerCase().includes(filter)) return false;
    return true;
  });
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; color:#9399b2;">–ù–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
    return;
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º —Ç–∏–ø–∞
  const formatValue = (reg) => {
    if (reg.value === null) return '<span style="color:#6c7086">‚Äî</span>';
    if (reg.type === 'String') return `"${reg.value}"`;
    if (reg.type === 'Float') return parseFloat(reg.value).toFixed(2);
    if (reg.type === 'TCP56') return formatCP56(reg.value); // —Å–º. –Ω–∏–∂–µ
    return reg.value;
  };
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CP56 (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
  const formatCP56 = (val) => {
    if (!val || typeof val !== 'number') return '‚Äî';
    // CP56: 7 –±–∞–π—Ç, BCD-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –≤—ã–≤–æ–¥–∏–º –∫–∞–∫ –µ—Å—Ç—å
    return `0x${val.toString(16).toUpperCase()}`;
  };
  
  tbody.innerHTML = filtered.map(r => {
    const accessClass = r.access.includes('E') ? 'success' : 
                       (r.access.includes('W') ? 'info' : 'error');
    const flagBadge = r.flag ? `<span style="background:var(--input);padding:2px 4px;border-radius:3px;font-size:0.8em;">${r.flag}</span>` : '';
    
    return `
      <tr>
        <td><code>${r.addrHex}</code></td>
        <td>${r.mnemonic} ${flagBadge}</td>
        <td><span class="${accessClass}" style="padding:2px 6px;border-radius:3px;font-size:0.85em;">${r.access}</span></td>
        <td>${r.count}</td>
        <td>${r.type}</td>
        <td>${r.min ?? '‚Äî'}</td>
        <td>${r.max ?? '‚Äî'}</td>
        <td title="${r.description}">${r.description.substring(0, 25)}${r.description.length > 25 ? '...' : ''}</td>
        <td id="val-${r.addr}">${formatValue(r)}</td>
        <td>
          ${r.writable ? `<button class="btn" style="padding:4px 8px;" onclick="editRegister(${r.addr}, ${slaveId}, '${r.type}')">‚úèÔ∏è</button>` : ''}
          <button class="btn" style="padding:4px 8px;" onclick="readRegister(${r.addr}, ${r.count}, ${slaveId}, '${r.type}')">üì•</button>
        </td>
      </tr>
    `;
  }).join('');
};

// –ß—Ç–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞
window.readRegister = async (addr, count, slaveId, type) => {
  log('importLog', `üì• Reading 0x${addr.toString(16).toUpperCase()} (${count} regs)...`, 'info');
  
  const { result, error } = await sendRpc('modbus.read', {
    slave_id: slaveId,
    address: addr,
    count: count,
    input: false
  });
  
  if (error) {
    log('importLog', `‚úó ${error.message}`, 'error');
    const el = $(`val-${addr}`);
    if (el) el.innerHTML = `<span class="error">ERR</span>`;
    return;
  }
  
  // ‚úÖ –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ –±—ç–∫–µ–Ω–¥–∞
  const values = result?.values || [];
  if (values.length === 0) {
    log('importLog', `‚ö† –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç`, 'error');
    return;
  }
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
  const parsedValue = convertModbusValues(values, type);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –≤ –º–∞—Å—Å–∏–≤–µ registers
  const reg = registers.find(r => r.addr === addr);
  if (reg) reg.value = parsedValue;
  
  const el = $(`val-${addr}`);
  if (el) {
    el.textContent = formatDisplayValue(parsedValue, type);
    el.classList.add('success');
    setTimeout(() => el.classList.remove('success'), 1000);
  }
  
  log('importLog', `‚úì 0x${addr.toString(16).toUpperCase()} = ${formatDisplayValue(parsedValue, type)}`, 'success');
};

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–ª—è –∑–∞–ø–∏—Å–∏)
// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–ª—è –∑–∞–ø–∏—Å–∏)
// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–ª—è –∑–∞–ø–∏—Å–∏)
window.editRegister = async (addr, slaveId, type) => {
  const reg = registers.find(r => r.addr === addr);
  if (!reg) return;
  
  let defaultVal = reg.value ?? '';
  if (type === 'Float' && typeof defaultVal === 'number') {
    defaultVal = defaultVal.toFixed(2);
  }
  
  const rangeInfo = `–î–æ–ø—É—Å—Ç–∏–º–æ: ${reg.min ?? '‚Äì'} ‚Ä¶ ${reg.max ?? '‚Äì'}`;
  const newVal = prompt(
    `–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ${reg.addrHex} ${reg.mnemonic} (${type})\n${rangeInfo}`,
    defaultVal
  );
  if (newVal === null) return;
  
  let parsedVal;
  if (type === 'String') {
    parsedVal = newVal;
  } else if (type === 'Float') {
    parsedVal = parseFloat(newVal);
    if (isNaN(parsedVal)) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
      return;
    }
  } else {
    parsedVal = parseInt(newVal);
    if (isNaN(parsedVal)) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ');
      return;
    }
    if (reg.min !== null && parsedVal < reg.min) {
      alert(`–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞ (${reg.min})`);
      return;
    }
    if (reg.max !== null && parsedVal > reg.max) {
      alert(`–ó–Ω–∞—á–µ–Ω–∏–µ –≤—ã—à–µ –º–∞–∫—Å–∏–º—É–º–∞ (${reg.max})`);
      return;
    }
  }
  
  log('importLog', `‚úçÔ∏è Writing ${parsedVal} to 0x${addr.toString(16).toUpperCase()}...`, 'info');
  
  const { result, error } = await sendRpc('modbus.write', {
    slave_id: slaveId,
    address: addr,
    value: type === 'String' ? parsedVal : (type === 'Float' ? parsedVal : parsedVal)
  });
  
  if (error) {
    log('importLog', `‚úó ${error.message}`, 'error');
    return;
  }
  
  reg.value = parsedVal;
  const el = $(`val-${addr}`);
  if (el) {
    el.textContent = formatDisplayValue(parsedVal, type);
    el.classList.add('success');
    setTimeout(() => el.classList.remove('success'), 1000);
  }
  
  log('importLog', `‚úì Write OK`, 'success');
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
$('importBtn').onclick = () => {
  const file = $('csvFile').files[0];
  if (!file) {
    log('importLog', '‚ö† –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      registers = parseRegisterCsv(e.target.result);
      log('importLog', `‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${registers.length} —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤`, 'success');
      renderRegisters();
      
      // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É "–ß–∏—Ç–∞—Ç—å –≤—Å–µ"
      const readAllBtn = $('readAllBtn');
      if (readAllBtn) {
        readAllBtn.disabled = registers.length === 0;
        readAllBtn.textContent = registers.length > 0 
          ? `üì° –ß–∏—Ç–∞—Ç—å –≤—Å–µ (${registers.length})` 
          : 'üì° –ß–∏—Ç–∞—Ç—å –≤—Å–µ';
      }
      
    } catch (err) {
      log('importLog', `‚úó –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${err.message}`, 'error');
      console.error(err);
    }
  };
  reader.onerror = () => {
    log('importLog', '‚úó –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
  };
  reader.readAsText(file);
};

$('clearRegistersBtn').onclick = () => {
  registers = [];
  $('registersBody').innerHTML = '<tr><td colspan="10" style="text-align:center; color:#9399b2;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤</td></tr>';
  log('importLog', 'üóëÔ∏è –°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω', 'info');
};

$('registerFilter').oninput = (e) => renderRegisters(e.target.value);
$('filterRwe').onchange = () => renderRegisters($('registerFilter').value);
$('filterSlave').onchange = () => renderRegisters($('registerFilter').value);
const convertModbusValues = (values, type) => {
  if (!values || values.length === 0) return null;
  
  switch (type) {
    case 'Word':
    case 'Byte':
    case 'Int8':
    case 'Int16':
      return values[0];
    
    case 'Int32':
      if (values.length >= 2) {
        // Little-endian: low word first
        return (values[1] << 16) | values[0];
      }
      return values[0];
    
    case 'Float':
      if (values.length >= 2) {
        return wordsToFloat(values[0], values[1]);
      }
      return null;
    
    case 'String':
      return wordsToString(values);
    
    case 'TCP56':
      return formatCP56(values);
    
    case 'Array':
      return values;
    
    default:
      return values[0];
  }
};

// Word ‚Üí Float (IEEE 754, little-endian)
const wordsToFloat = (low, high) => {
  const buffer = new ArrayBuffer(4);
  const view = new DataView(buffer);
  view.setUint16(0, low, true);   // low word, little-endian
  view.setUint16(2, high, true);  // high word, little-endian
  return view.getFloat32(0, true);
};

// Word[] ‚Üí String (–∫–∞–∂–¥—ã–π Word = 2 —Å–∏–º–≤–æ–ª–∞ ASCII)
const wordsToString = (values) => {
  let str = '';
  for (const word of values) {
    if (word === 0) break;
    str += String.fromCharCode(word & 0xFF);
    str += String.fromCharCode((word >> 8) & 0xFF);
  }
  return str.trim();
};

// CP56 Time (7 –±–∞–π—Ç = 4 Word, —É–ø—Ä–æ—â—ë–Ω–Ω–æ)
const formatCP56 = (values) => {
  if (values.length < 4) return '‚Äî';
  // –£–ø—Ä–æ—â—ë–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ hex
  return values.map(v => '0x' + v.toString(16).toUpperCase().padStart(4, '0')).join(' ');
};

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ
const formatDisplayValue = (value, type) => {
  if (value === null || value === undefined) return '<span style="color:#6c7086">‚Äî</span>';
  
  if (type === 'String') {
    return `"${value}"`;
  }
  
  if (type === 'Float') {
    return typeof value === 'number' ? value.toFixed(2) : value;
  }
  
  if (type === 'Array') {
    return Array.isArray(value) ? `[${value.join(', ')}]` : value;
  }
  
  if (type === 'TCP56') {
    return value;
  }
  
  // –ß–∏—Å–ª–∞
  if (typeof value === 'number') {
    // –ï—Å–ª–∏ –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ hex
    if (value > 255) {
      return `${value} (0x${value.toString(16).toUpperCase()})`;
    }
    return value;
  }
  
  return value;
};
// –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º

// ==================== READ ALL REGISTERS ====================

// –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∏ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç –±—ç–∫–µ–Ω–¥–∞
// ==================== READ ALL REGISTERS (SEQUENTIAL FOR RTU) ====================

window.readAllRegisters = async () => {
  // === 0. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ ===
  if (registers.length === 0) {
    log('importLog', '‚ö† –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞–º–∏', 'error');
    return;
  }
  
  const slaveId = parseInt($('filterSlave').value) || 1;
  const readAllBtn = $('readAllBtn');
  const importBtn = $('importBtn');
  const progressDiv = $('readProgress');
  const progressBar = $('progressBar');
  const progressText = $('progressText');
  const progressPercent = $('progressPercent');
  
  // === 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ ===
  let isRtu = false;
  try {
    const { result } = await sendRpc('transport.status');
    isRtu = result?.type === 'rtu';
  } catch (e) {
    console.warn('[Transport] Could not detect type, assuming RTU');
    isRtu = true;
  }
  
  // === 2. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===
  const BATCH_SIZE = 1;  // üî• –í—Å–µ–≥–¥–∞ 1 –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
  const DELAY_MS = isRtu ? 400 : 150;  // RTU –º–µ–¥–ª–µ–Ω–Ω–µ–µ
  const REQUEST_TIMEOUT = isRtu ? 30000 : 10000;  // –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞
  
  // === 3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI ===
  readAllBtn.disabled = true;
  if (importBtn) importBtn.disabled = true;
  progressDiv.classList.remove('hidden');
  
  let completed = 0;
  let success = 0;
  let failed = 0;
  const total = registers.length;
  
  // === 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ ===
  const updateProgress = () => {
    const percent = Math.round((completed / total) * 100);
    progressBar.style.width = percent + '%';
    progressPercent.textContent = `${percent}% (${success}‚úì ${failed}‚úó)`;
    progressText.textContent = `–ü—Ä–æ—á–∏—Ç–∞–Ω–æ ${completed} –∏–∑ ${total} —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤...`;
  };
  
  // === 5. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–∞—Å—Å–∏–≤–∞ Word –≤ –Ω—É–∂–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ===
  const convertModbusValues = (values, type) => {
    if (!values || !Array.isArray(values) || values.length === 0) return null;
    
    switch (type) {
      case 'Word':
      case 'Byte':
      case 'Int8':
      case 'Int16':
        return values[0];
      
      case 'Int32':
        if (values.length >= 2) {
          // Little-endian: low word first
          return (values[1] << 16) | values[0];
        }
        return values[0];
      
      case 'Float':
        if (values.length >= 2) {
          return wordsToFloat(values[0], values[1]);
        }
        return null;
      
      case 'String':
        return wordsToString(values);
      
      case 'TCP56':
        return formatCP56(values);
      
      case 'Array':
        return values;
      
      default:
        return values[0];
    }
  };
  
  // Word ‚Üí Float (IEEE 754, little-endian)
  const wordsToFloat = (low, high) => {
    const buffer = new ArrayBuffer(4);
    const view = new DataView(buffer);
    view.setUint16(0, low, true);
    view.setUint16(2, high, true);
    return view.getFloat32(0, true);
  };
  
  // Word[] ‚Üí String (–∫–∞–∂–¥—ã–π Word = 2 —Å–∏–º–≤–æ–ª–∞ ASCII)
  const wordsToString = (values) => {
    let str = '';
    for (const word of values) {
      if (word === 0) break;
      str += String.fromCharCode(word & 0xFF);
      str += String.fromCharCode((word >> 8) & 0xFF);
    }
    return str.trim();
  };
  
  // CP56 Time (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
  const formatCP56 = (values) => {
    if (!values || values.length < 4) return '‚Äî';
    return values.map(v => '0x' + v.toString(16).toUpperCase().padStart(4, '0')).join(' ');
  };
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ
  const formatDisplayValue = (value, type) => {
    if (value === null || value === undefined) return '<span style="color:#6c7086">‚Äî</span>';
    if (type === 'String') return `"${value}"`;
    if (type === 'Float' && typeof value === 'number') return value.toFixed(2);
    if (type === 'Array' && Array.isArray(value)) return `[${value.join(', ')}]`;
    if (type === 'TCP56') return value;
    if (typeof value === 'number' && value > 255) {
      return `${value} (0x${value.toString(16).toUpperCase()})`;
    }
    return value;
  };
  
  // === 6. –ß—Ç–µ–Ω–∏–µ –û–î–ù–û–ì–û —Ä–µ–≥–∏—Å—Ç—Ä–∞ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ) ===
  const readSingle = async (reg) => {
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä—É
    const filter = $('registerFilter').value.toLowerCase();
    const onlyRwe = $('filterRwe').checked;
    
    if (onlyRwe && !reg.access.includes('W')) return true;
    if (filter && !reg.addrHex.toLowerCase().includes(filter) && 
                  !reg.mnemonic.toLowerCase().includes(filter) &&
                  !reg.description.toLowerCase().includes(filter)) return true;
    
    try {
      // üî• –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è fetch
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
      
      const payload = {
        jsonrpc: '2.0',
        method: 'modbus.read',
        params: {
          slave_id: slaveId,
          address: reg.addr,
          count: reg.count,
          input: false
        },
        id: Date.now() + Math.random()
      };
      
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      
      const json = await res.json();
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ Modbus
      if (json.error) {
        failed++;
        const el = $(`val-${reg.addr}`);
        if (el) {
          // –†–∞–∑–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ—à–∏–±–æ–∫
          if (json.error.code === -32000 && json.error.data === 2) {
            el.innerHTML = `<span style="color:#6c7086">N/A</span>`; // –ê–¥—Ä–µ—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
          } else {
            el.innerHTML = `<span class="error">ERR</span>`;
          }
        }
        console.warn(`[Read] ${reg.addrHex} (${reg.mnemonic}): ${json.error.message}`);
        return false;
      }
      
      // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –æ—Ç–≤–µ—Ç–∞
      const values = json.result?.values;
      if (!Array.isArray(values) || values.length === 0) {
        failed++;
        const el = $(`val-${reg.addr}`);
        if (el) el.innerHTML = `<span style="color:#6c7086">EMPTY</span>`;
        return false;
      }
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É
      const parsedValue = convertModbusValues(values, reg.type);
      reg.value = parsedValue;
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
      const el = $(`val-${reg.addr}`);
      if (el) {
        el.textContent = formatDisplayValue(parsedValue, reg.type);
        el.classList.add('success');
        setTimeout(() => el.classList.remove('success'), 300);
      }
      
      // üî• –£—Å–ø–µ—Ö: –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ null –ò–õ–ò —Ç–∏–ø String
      if (parsedValue !== null || reg.type === 'String') {
        success++;
      } else {
        failed++;
      }
      
      return true;
      
    } catch (e) {
      failed++;
      console.error(`[Read] ${reg.addrHex}: ${e.message}`);
      const el = $(`val-${reg.addr}`);
      if (el) el.innerHTML = `<span style="color:#f38ba8">TO</span>`; // TO = timeout
      return false;
    }
  };
  
  // === 7. –°—Ç–∞—Ä—Ç ===
  log('importLog', `üì° –ó–∞–ø—É—Å–∫ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–ì–û —á—Ç–µ–Ω–∏—è ${total} —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ (${isRtu ? 'RTU' : 'TCP'}, slave=${slaveId})...`, 'info');
  const startTime = Date.now();
  
  // === 8. –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–ï —á—Ç–µ–Ω–∏–µ (–∫–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ!) ===
  for (let i = 0; i < total; i++) {
    const reg = registers[i];
    
    // –ß–∏—Ç–∞–µ–º –∏ –ñ–î–Å–ú –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    await readSingle(reg);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    completed++;
    updateProgress();
    
    // üî• –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ RTU
    if (i < total - 1) {  // –ù–µ –∂–¥–∞—Ç—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
      await new Promise(resolve => setTimeout(resolve, DELAY_MS));
    }
  }
  
  // === 9. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ ===
  const duration = ((Date.now() - startTime) / 1000).toFixed(1);
  const successRate = total > 0 ? Math.round((success / total) * 100) : 0;
  
  log('importLog', `‚úì –ß—Ç–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ ${duration}—Å: ${success}‚úì ${failed}‚úó –∏–∑ ${total} (${successRate}%)`, 
      failed > 0 ? 'error' : 'success');
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  const stats = `
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
  ‚Ä¢ –í—Å–µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤: ${total}
  ‚Ä¢ –£—Å–ø–µ—à–Ω–æ: ${success} (${successRate}%)
  ‚Ä¢ –û—à–∏–±–∫–∏: ${failed}
  ‚Ä¢ –í—Ä–µ–º—è: ${duration}—Å
  ‚Ä¢ –°–∫–æ—Ä–æ—Å—Ç—å: ${(total/duration).toFixed(1)} —Ä–µ–≥/—Å
  ‚Ä¢ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ${isRtu ? 'RTU' : 'TCP'}
  ‚Ä¢ Slave ID: ${slaveId}`;
  log('importLog', stats, 'info');
  
  // === 10. –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI ===
  readAllBtn.disabled = false;
  if (importBtn) importBtn.disabled = false;
  
  // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
  setTimeout(() => {
    progressDiv.classList.add('hidden');
    progressBar.style.width = '0%';
  }, 3000);
};

// === –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ ===
$('readAllBtn').onclick = readAllRegisters;
$('showStatsBtn').onclick = () => {
  const withValues = registers.filter(r => r.value !== null);
  const byType = {};
  registers.forEach(r => {
    byType[r.type] = (byType[r.type] || 0) + 1;
  });
  
  const stats = `
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤:
  ‚Ä¢ –í—Å–µ–≥–æ: ${registers.length}
  ‚Ä¢ –° –∑–Ω–∞—á–µ–Ω–∏—è–º–∏: ${withValues.length} (${Math.round(withValues.length/registers.length*100)}%)
  ‚Ä¢ –ë–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–π: ${registers.length - withValues.length}
  
üìã –ü–æ —Ç–∏–ø–∞–º:
${Object.entries(byType).map(([type, count]) => `  ‚Ä¢ ${type}: ${count}`).join('\n')}
  
üíæ –ü—Ä–∏–º–µ—Ä—ã –∑–Ω–∞—á–µ–Ω–∏–π:
${withValues.slice(0, 10).map(r => `  ‚Ä¢ ${r.addrHex} ${r.mnemonic}: ${r.value}`).join('\n')}
`;
  
  log('importLog', stats, 'info');
};
</script>

</body>
</html>
